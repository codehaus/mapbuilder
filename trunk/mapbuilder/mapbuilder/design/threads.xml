<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE section PUBLIC "-//OASIS//DTD Simplified DocBook XML V1.0//EN"
"http://www.oasis-open.org/docbook/xml/simple/1.0/sdocbook.dtd">
<section>
  <title>Mapbuilder Threads</title>

  <para>This document traces Mapbuilder threads. This information would
  probably be better presented as UML sequence diagrams, however working with
  Sequence diagrams using <emphasis>Poseidon UML</emphasis> is too slow and
  the diagrams are quite complicated.</para>

  <section>
    <title>Initialisation</title>

    <para>This traces the thread during initialisation. These threads load
    javascript files.</para>

    <table>
      <title>Start Loading Javascript files</title>

      <tgroup cols="3">
        <thead>
          <row>
            <entry>Object</entry>

            <entry>Code</entry>

            <entry>Description</entry>
          </row>
        </thead>

        <tbody>
          <row>
            <entry>complete.html</entry>

            <entry>&lt;script src="../lib/Mapbuilder.js"/&gt;</entry>

            <entry>Load Mapbuilder.js script.</entry>
          </row>

          <row>
            <entry>Mapbuilder</entry>

            <entry>. mapbuilder=new Mapbuilder()</entry>

            <entry><para></para></entry>
          </row>

          <row>
            <entry>Mapbuilder</entry>

            <entry>.. this.setLoadState(MB_LOAD_CORE)</entry>

            <entry><para></para></entry>
          </row>

          <row>
            <entry>Mapbuilder.setLoadState</entry>

            <entry>... this.loadScript()</entry>

            <entry>Load the javascript files.</entry>
          </row>

          <row>
            <entry>Mapbuilder.setLoadState</entry>

            <entry>... config=new Config(mbConfigUrl)<para>...
            config.loadConfigScripts()</para></entry>

            <entry>Load all javascript for the Objects defined in the config
            file.</entry>
          </row>

          <row>
            <entry>Config.loadConfigScripts()</entry>

            <entry>.... this.loadScriptsFromXpath()</entry>

            <entry>Called for "mb:models/*", "mb:widgets/*",
            "mb:tools/*"</entry>
          </row>

          <row>
            <entry>Config.loadScriptsFromXpath()</entry>

            <entry>..... mapbuilder.loadScript()</entry>

            <entry></entry>
          </row>
        </tbody>
      </tgroup>
    </table>

    <table>
      <title>Monitor loading Javascript</title>

      <tgroup cols="3">
        <thead>
          <row>
            <entry>Object</entry>

            <entry>Code</entry>

            <entry>Description</entry>
          </row>
        </thead>

        <tbody>
          <row>
            <entry>Mapbuilder</entry>

            <entry>this.checkScriptsLoaded</entry>

            <entry><para>Called Periodically.</para><para>Wait for javascript
            files to load, then increment LOAD_STATE. This will trigger
            mapbuilderInit() to be called.</para></entry>
          </row>
        </tbody>
      </tgroup>
    </table>

    <table>
      <title>After HTML and Javascript is loaded, send "loadModel" and
      "refresh" events</title>

      <tgroup cols="3">
        <thead>
          <row>
            <entry>Object</entry>

            <entry>Code</entry>

            <entry>Description</entry>
          </row>
        </thead>

        <tbody>
          <row>
            <entry>complete.html</entry>

            <entry>onload="mbDoLoad()"</entry>

            <entry>Called after HTML and Mapbuilder.js is loaded.</entry>
          </row>

          <row>
            <entry>Mapbuilder.mbDoLoad()</entry>

            <entry></entry>

            <entry>Starts a periodic event which checks to see if all scripts
            have been loaded.</entry>
          </row>

          <row>
            <entry>Mabuilder</entry>

            <entry>mapbuilderInit()</entry>

            <entry><para>Called periodically.</para><para>Sends config
            "loadModel" and "refresh" events after all scripts have
            loaded.</para></entry>
          </row>
        </tbody>
      </tgroup>
    </table>
  </section>
</section>