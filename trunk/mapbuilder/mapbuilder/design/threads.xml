<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE section PUBLIC "-//OASIS//DTD Simplified DocBook XML V1.0//EN"
"http://www.oasis-open.org/docbook/xml/simple/1.0/sdocbook.dtd">
<section>
  <title>Mapbuilder Threads</title>

  <para>This document traces Mapbuilder threads. This information would
  probably be better presented as UML sequence diagrams, however working with
  Sequence diagrams using <emphasis>Poseidon UML</emphasis> is too slow and
  the diagrams are quite complicated.</para>

  <section>
    <title>Initialisation</title>

    <para>This traces the thread during initialisation. These threads load
    javascript files.</para>

    <table>
      <title>Start Loading Javascript files</title>

      <tgroup cols="3">
        <thead>
          <row>
            <entry>Object</entry>

            <entry>Code</entry>

            <entry>Description</entry>
          </row>
        </thead>

        <tbody>
          <row>
            <entry>complete.html</entry>

            <entry>&lt;script src="../lib/Mapbuilder.js"/&gt;</entry>

            <entry>Load Mapbuilder.js script.</entry>
          </row>

          <row>
            <entry>Mapbuilder</entry>

            <entry>. mapbuilder=new Mapbuilder()</entry>

            <entry><para></para></entry>
          </row>

          <row>
            <entry>Mapbuilder</entry>

            <entry>.. this.setLoadState(MB_LOAD_CORE)</entry>

            <entry><para></para></entry>
          </row>

          <row>
            <entry>Mapbuilder.setLoadState()</entry>

            <entry>... this.loadScript()</entry>

            <entry>Load the javascript files.</entry>
          </row>

          <row>
            <entry>Mapbuilder.setLoadState()</entry>

            <entry>... config=new Config(mbConfigUrl)<para>...
            config.loadConfigScripts()</para></entry>

            <entry>Load all javascript for the Objects defined in the config
            file.</entry>
          </row>

          <row>
            <entry>Config.loadConfigScripts()</entry>

            <entry>.... this.loadScriptsFromXpath()</entry>

            <entry>Called for "mb:models/*", "mb:widgets/*",
            "mb:tools/*"</entry>
          </row>

          <row>
            <entry>Config.loadScriptsFromXpath()</entry>

            <entry>..... mapbuilder.loadScript()</entry>

            <entry></entry>
          </row>
        </tbody>
      </tgroup>
    </table>

    <table>
      <title>Monitor loading Javascript</title>

      <tgroup cols="3">
        <thead>
          <row>
            <entry>Object</entry>

            <entry>Code</entry>

            <entry>Description</entry>
          </row>
        </thead>

        <tbody>
          <row>
            <entry>Mapbuilder</entry>

            <entry>this.checkScriptsLoaded</entry>

            <entry><para>Called Periodically.</para><para>Wait for javascript
            files to load, then increment LOAD_STATE. This will trigger
            mapbuilderInit() to be called.</para></entry>
          </row>
        </tbody>
      </tgroup>
    </table>

    <table>
      <title>Wait for Javascript and HTML to load</title>

      <tgroup cols="3">
        <thead>
          <row>
            <entry>Object</entry>

            <entry>Code</entry>

            <entry>Description</entry>
          </row>
        </thead>

        <tbody>
          <row>
            <entry>complete.html</entry>

            <entry>onload="mbDoLoad()"</entry>

            <entry>Called after HTML and Mapbuilder.js is loaded.</entry>
          </row>

          <row>
            <entry>Mapbuilder.mbDoLoad()</entry>

            <entry>.</entry>

            <entry>Starts a periodic event which checks to see if all scripts
            have been loaded.</entry>
          </row>
        </tbody>
      </tgroup>
    </table>

    <table>
      <title>Instantiate Javascript Objects</title>

      <tgroup cols="3">
        <thead>
          <row>
            <entry>Object</entry>

            <entry>Code</entry>

            <entry>Description</entry>
          </row>
        </thead>

        <tbody>
          <row>
            <entry>Mapbuilder</entry>

            <entry>mapbuilderInit()</entry>

            <entry><para>Called periodically.</para><para>Sends config
            "loadModel" and "refresh" events after all scripts have
            loaded.</para></entry>
          </row>

          <row>
            <entry>Mabuilder.mapbuilderInit()</entry>

            <entry>. config.init(config)</entry>

            <entry></entry>
          </row>

          <row>
            <entry>ModelBase.init()</entry>

            <entry>.. this.loadObjects()</entry>

            <entry><para>Load models/* widgets/* tools/*</para><emphasis>CS
            Jan 05: Shouldn't this function be moved into
            Config.js?</emphasis></entry>
          </row>

          <row>
            <entry>ModelBase.loadObjects()</entry>

            <entry>...newObject=eval("new
            "+objectType+"(configNode)");</entry>

            <entry><para>Instantiate javascript objects:</para><para>Create
            all the child model javascript objects for this model. A reference
            to the created model is stored as a js property of the model using
            the model's ID; so you can always get a reference to a widget by
            using: "config.modelId.subModelId...". Similarly, a reference to
            the model is added as a property of config so it is also available
            as "config.subModelId".</para></entry>
          </row>

          <row>
            <entry>ModelBase</entry>

            <entry>.... model.init</entry>

            <entry></entry>
          </row>

          <row>
            <entry>ModelBase.init()</entry>

            <entry>..... this.loadObjects()</entry>

            <entry><emphasis>CS Jan 05: Called again in the same thread!? Can
            this be simplified?</emphasis></entry>
          </row>

          <row>
            <entry></entry>

            <entry></entry>

            <entry></entry>
          </row>

          <row>
            <entry>Mapbuilder.mapbuilderInit()</entry>

            <entry>.. config.callListeners()</entry>

            <entry>Call "loadModel" and "refresh" listeners.</entry>
          </row>
        </tbody>
      </tgroup>
    </table>
  </section>

  <section>
    <title>AddNodeToContext event</title>

    <para></para>
  </section>

  <section>
    <title>aoi event</title>

    <para></para>
  </section>

  <section>
    <title>boundingBox event</title>

    <para></para>
  </section>

  <section>
    <title>DescribeFeatureType event</title>

    <para></para>
  </section>

  <section>
    <title>GetFeature event</title>

    <para></para>
  </section>

  <section>
    <title>GetMap event</title>

    <para></para>
  </section>

  <section>
    <title>hidden event</title>

    <para></para>
  </section>

  <section>
    <title>httpPayload event</title>

    <para></para>
  </section>

  <section>
    <title>loadModel event</title>

    <para>The "loadModel" event is sent before a new model is loaded so that
    widgets associated with the previous model are removed from the
    HTML.</para>

    <para><emphasis>CS Jan 05: HTML nodes shouldn't automatically be removed
    when a new Model is loaded.</emphasis></para>

    <para><emphasis>CS Jan 05: The only reason to remove nodes is if the
    Context changes. Therefore, only widgets of Context models should register
    for this event.</emphasis></para>

    <table>
      <title>Register for event</title>

      <tgroup cols="3">
        <thead>
          <row>
            <entry>Object</entry>

            <entry>Code</entry>

            <entry>Description</entry>
          </row>
        </thead>

        <tbody>
          <row>
            <entry>WidgetBase</entry>

            <entry>widget.model.addListener( "newModel", widget.clearWidget,
            widget);</entry>

            <entry><para></para></entry>
          </row>
        </tbody>
      </tgroup>
    </table>

    <table>
      <title>Process event</title>

      <tgroup cols="3">
        <thead>
          <row>
            <entry>Object</entry>

            <entry>Code</entry>

            <entry>Description</entry>
          </row>
        </thead>

        <tbody>
          <row>
            <entry>ModelBase.loadModelDoc()</entry>

            <entry></entry>

            <entry>Called before new model is loaded.</entry>
          </row>

          <row>
            <entry>WidgetBase.clearWidget()</entry>

            <entry></entry>

            <entry><para>Remove old widget from display.</para></entry>
          </row>
        </tbody>
      </tgroup>
    </table>
  </section>

  <section>
    <title>modelSaved event</title>

    <para></para>
  </section>

  <section>
    <title>mousedown mousemove mouseout mouseover mouseup events</title>

    <para></para>
  </section>

  <section>
    <title>newModel event</title>

    <para></para>
  </section>

  <section>
    <title>paint event</title>

    <para></para>
  </section>

  <section>
    <title>refresh event</title>

    <para></para>
  </section>
</section>