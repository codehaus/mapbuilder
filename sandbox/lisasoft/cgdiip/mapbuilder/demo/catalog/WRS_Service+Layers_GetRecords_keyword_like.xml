<?xml version="1.0" encoding="UTF-8"?>
<GetRecords 
xmlns:csw="http://www.opengis.net/csw" 
xmlns:ogc="http://www.opengis.net/ogc" 
xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance http://schemas.cubewerx.com/ogc/1.0.0/filter.xsd" 
xmlns:gml="http://www.opengis.net/gml" 
csw:schemaLocation="http://www.opengis.net/csw http://schemas.cubewerx.com/csw/2.0.0/CSW-discovery.xsd" 
ogc:schemaLocation="http://www.opengis.net/ogc" 
service="WRS" 
version="2.0.0" 
outputFormat="text/xml" 
startPosition="1" 
maxRecords="1000" 
resultType="RESULTS">
	<Query typeNames="ExtrinsicObject Association=ServiceAssociation Service">
		<ElementName>/ExtrinsicObject</ElementName>
		<ElementName>/Service</ElementName>
		<Constraint>
			<ogc:Filter>
				<ogc:And>
					<!-- The object type has to be either a feature type (WFS layer) or WMS_Layer -->
					<ogc:Or>
						<ogc:PropertyIsLike>
							<ogc:PropertyName>/ExtrinsicObject/@objectType</ogc:PropertyName>
							<ogc:Literal>FeatureType</ogc:Literal>
						</ogc:PropertyIsLike>
						<ogc:PropertyIsLike>
							<ogc:PropertyName>/ExtrinsicObject/@objectType</ogc:PropertyName>
							<ogc:Literal>WMS_Layer</ogc:Literal>
						</ogc:PropertyIsLike>
					</ogc:Or>
					
					<!-- Link the layer (coming from the extrinsic object), to the service object via the "Serves" association -->
					<ogc:And>
						<ogc:PropertyIsEqualTo>
							<ogc:PropertyName>/ExtrinsicObject/@ID</ogc:PropertyName>
							<ogc:PropertyName>/ServiceAssociation/@targetObject</ogc:PropertyName>
						</ogc:PropertyIsEqualTo>
						<ogc:PropertyIsLike>
							<ogc:PropertyName>/ServiceAssociation/@associationType</ogc:PropertyName>
							<ogc:Literal>Serves</ogc:Literal>
						</ogc:PropertyIsLike>
						<ogc:PropertyIsEqualTo>
							<ogc:PropertyName>/Service/@ID</ogc:PropertyName>
							<ogc:PropertyName>/ServiceAssociation/@sourceObject</ogc:PropertyName>
						</ogc:PropertyIsEqualTo>
					</ogc:And>

					<!-- Keyword searches -->
					<ogc:And>
						<!-- Search for the first keyword -->
						<ogc:Or>
							<ogc:PropertyIsLike>
								<ogc:PropertyName>/ExtrinsicObject/Name/LocalizedString/@value</ogc:PropertyName>
								<ogc:Literal>%KEYWORD_SEARCH1%</ogc:Literal>
							</ogc:PropertyIsLike>
							<ogc:PropertyIsLike>
								<ogc:PropertyName>/ExtrinsicObject/Description/LocalizedString/@value</ogc:PropertyName>
								<ogc:Literal>%KEYWORD_SEARCH1%</ogc:Literal>
							</ogc:PropertyIsLike>
							<ogc:And>
								<ogc:PropertyIsEqualTo>
									<ogc:PropertyName>/ExtrinsicObject/Slot/@name</ogc:PropertyName>
									<ogc:Literal>Keyword</ogc:Literal>
								</ogc:PropertyIsEqualTo>
								<ogc:PropertyIsLike>
									<ogc:PropertyName>/ExtrinsicObject/Slot/ValueList/Value</ogc:PropertyName>
									<ogc:Literal>%KEYWORD_SEARCH1%</ogc:Literal>
								</ogc:PropertyIsLike>
							</ogc:And>
						</ogc:Or>

						<!-- Search for the second keyword -->
						<ogc:Or>
							<ogc:PropertyIsLike>
								<ogc:PropertyName>/ExtrinsicObject/Name/LocalizedString/@value</ogc:PropertyName>
								<ogc:Literal>%KEYWORD_SEARCH2%</ogc:Literal>
							</ogc:PropertyIsLike>
							<ogc:PropertyIsLike>
								<ogc:PropertyName>/ExtrinsicObject/Description/LocalizedString/@value</ogc:PropertyName>
								<ogc:Literal>%KEYWORD_SEARCH2%</ogc:Literal>
							</ogc:PropertyIsLike>
							<ogc:And>
								<ogc:PropertyIsEqualTo>
									<ogc:PropertyName>/ExtrinsicObject/Slot/@name</ogc:PropertyName>
									<ogc:Literal>Keyword</ogc:Literal>
								</ogc:PropertyIsEqualTo>
								<ogc:PropertyIsLike>
									<ogc:PropertyName>/ExtrinsicObject/Slot/ValueList/Value</ogc:PropertyName>
									<ogc:Literal>%KEYWORD_SEARCH2%</ogc:Literal>
								</ogc:PropertyIsLike>
							</ogc:And>
						</ogc:Or>
					</ogc:And>
				</ogc:And>
			</ogc:Filter>
		</Constraint>
	</Query>
</GetRecords>
